---

- name: set VPC hostname list fact
  set_fact:
    _aws_vpcs: '{{ groups["aws_vpcs"] | sort }}'

- name: set VPC name list fact
  set_fact:
    _aws_vpc_names: >
      {{ (_aws_vpc_names | default([]))
         + [hostvars[item]["aws_vpc_name"]] }}
  with_items: '{{ _aws_vpcs }}'

- name: set flag for whether this host is a VPC
  set_fact:
    is_vpc: >-
      {{ ((inventory_hostname
           | truncate(length=8, killwords=True, end="", leeway=0))
          == 'aws-vpc-')
         | bool }}

- block:

    - include_role:
        name: aws-vpc
        tasks_from: vpc_id

    - include_role:
        name: aws-vpc
        tasks_from: vgw_ids

    - name: get AWS account number
      command: >
        aws sts get-caller-identity
                --output text
                --profile '{{ aws_profile }}'
                --query 'Account'
      register: _aws_vpc_account
      changed_when: False

    - name: set VPC virtual gateway ID fact
      set_fact:
        _aws_vpc_vgw_id: '{{ _aws_vpc_vgw_ids[0] }}'
        _aws_vpc_vgw_ids: {}

  when: is_vpc

- block:

    - name: set virtual gateway ID lookup dictionary fact
      set_fact:
        _aws_vpc_vgw_ids: >
          {{ _aws_vpc_vgw_ids
             | default({})
             | combine({item: hostvars[item]["_aws_vpc_vgw_id"]}) }}
      with_items: '{{ _aws_vpcs }}'
      when: hostvars[item]["_aws_vpc_vgw_id"] is defined

    - name: get Direct Connect connection ID
      command: >
        aws directconnect describe-connections
                          --output text
                          --profile '{{ aws_profile }}'
                          --query 'connections[*].connectionId'
      register: _aws_directconnect_id_command
      changed_when: False

    - name: set Direct Connect connection ID fact
      set_fact:
        _aws_directconnect_id: '{{ _aws_directconnect_id_command.stdout }}'

  when: inventory_hostname == aws_directconnect_account_hostname

- include_tasks: vifs.yml

- block:

    - name: allocate private virtual interfaces
      command: >
        aws directconnect allocate-private-virtual-interface
                          --connection-id '{{ _aws_directconnect_id }}'
                          --owner-account
                            '{{ hostvars["aws-vpc-" + item]
                                        ["_aws_vpc_account"].stdout }}'
                          --new-private-virtual-interface-allocation
                            '{{ lookup("template",
                                       playbook_dir
                                       + "/roles/aws-directconnect/templates/"
                                       + "private-vif-allocation.json.j2")
                                | to_nice_json }}'
                          --profile '{{ aws_profile }}'
      register: _aws_directconnect_private_vifs_allocate
      with_items: >
        {{ _aws_vpc_names | difference(_aws_directconnect_existing_vifs) }}

    - name: remove generated BGP key temporary file
      file:
        path: '{{ "/tmp/" + item + ".bgpkey" }}'
        state: absent
      with_items: >
        {{ _aws_vpc_names | difference(_aws_directconnect_existing_vifs) }}
      changed_when: False

  when: inventory_hostname == aws_directconnect_account_hostname

- include_tasks: vifs.yml

- block:

    - name: confirm private virtual interfaces
      command: >
        aws directconnect confirm-private-virtual-interface
                          --virtual-interface-id
                            '{{ _aws_directconnect_existing_vifs
                                  [aws_vpc_name]["virtualInterfaceId"] }}'
                          --virtual-gateway-id '{{ _aws_vpc_vgw_id }}'
                          --profile '{{ aws_profile }}'
      register: _aws_directconnect_private_vifs_confirm
      when: >
        _aws_directconnect_existing_vifs[aws_vpc_name]["virtualInterfaceState"]
        == "confirming"

  when: is_vpc
